import{u as _,b as O,n as m,h as g}from"./query.6a3ed619.js";import{d as P,k as b,m as k,n as x,o as J,p as R,S as A,r as S}from"./entry.bd5fb27e.js";import{r as U}from"./asyncData.fc179f24.js";import F from"./ContentPreviewMode.eb19e61b.js";import"./runtime-core.esm-bundler.9c14be38.js";import"./_plugin-vue_export-helper.c27b6911.js";/* empty css                               */const L=(u=[],v,h)=>{const f=[...v||[]],n=[...h||[]],p=JSON.parse(JSON.stringify(u));for(const s of f)if(s.oldPath)if(n.splice(n.findIndex(r=>r.path===s.oldPath),1),f.find(r=>r.path===s.oldPath))p.push({path:s.path,parsed:s.parsed});else{const r=p.find(d=>d.path===s.oldPath);r&&(r.path=s.path,s.parsed?r.parsed=s.parsed:s.pathMeta&&["_file","_path","_id","_locale"].forEach(d=>{r.parsed[d]=s.pathMeta[d]}))}else if(s.new)p.push({path:s.path,parsed:s.parsed});else{const l=p.find(r=>r.path===s.path);l&&Object.assign(l,{path:s.path,parsed:s.parsed})}for(const s of n)p.splice(p.findIndex(l=>l.path===s.path),1);const w=new Intl.Collator(void 0,{numeric:!0});return p.sort((s,l)=>w.compare(s.path,l.path)),p},D=b(()=>JSON.parse(JSON.stringify(k()))),B=()=>{const u=_(),v=O().public.studio||{},h=D();let f;const n=P("studio-client-db",()=>null),p=P("studio-preview-db-files",()=>[]);u.hook("content:storage",e=>{n.value=e});const w=async(e,t,i=!0)=>{const o=m("previewToken",{sameSite:"none",secure:!0}),c=await e.getKeys(`${o.value}:`);await Promise.all(c.map(a=>e.removeItem(a))),await e.setItem(`${o.value}$`,JSON.stringify({ignoreBuiltContents:i})),await Promise.all(t.map(a=>{var C;return e.setItem(`${o.value}:${(C=a.parsed)==null?void 0:C._id}`,JSON.stringify(a.parsed))}))},s=e=>{const t=g(u,k);x(t,e||h),e||J(t,h)},l=e=>{var i,o,c,a;const t=(a=(c=(o=(i=u==null?void 0:u.vueApp)==null?void 0:i._context)==null?void 0:o.config)==null?void 0:c.globalProperties)==null?void 0:a.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(f||(f=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),g(u,t.updateTheme,[e||f]))},r=async e=>{if(p.value=e.files=e.files||p.value||[],!n.value)return!1;const t=L(e.files,e.additions,e.deletions),i=t.filter(a=>!a.path.startsWith(A));await w(n.value,i,(e.files||[]).length!==0);const o=t.find(a=>a.path===S.appConfig);s(o==null?void 0:o.parsed);const c=t.find(a=>a.path===S.tokensConfig);return l(c==null?void 0:c.parsed),y(),!0},d=async()=>{const e=m("previewToken",{sameSite:"none",secure:!0});await $fetch("api/projects/preview/sync",{baseURL:v.apiURL,method:"POST",params:{token:e.value}})},T=()=>{const e=m("previewToken",{sameSite:"none",secure:!0}),t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),R(F,{previewToken:e,apiURL:v.apiURL,syncPreview:r,requestPreviewSyncAPI:d}).mount(t)},I=async e=>{var o,c;const t=m("previewToken",{sameSite:"none",secure:!0});if(!e)return null;e=e.replace(/\/$/,"");let i=await((o=n.value)==null?void 0:o.getItem(`${t.value}:${e}`));return i||(i=await((c=n.value)==null?void 0:c.getItem(e))),i},$=e=>{var i;const t=m("previewToken",{sameSite:"none",secure:!0});n.value&&n.value.setItem(`${t.value}:${(i=e.parsed)==null?void 0:i._id}`,JSON.stringify(e.parsed))},N=async e=>{var i;const t=m("previewToken",{sameSite:"none",secure:!0});await((i=n.value)==null?void 0:i.removeItem(`${t.value}:${e}`))},y=()=>{g(u,U)};return{apiURL:v.apiURL,contentStorage:n,syncPreviewFiles:w,syncPreviewAppConfig:s,syncPreviewTokensConfig:l,requestPreviewSynchronization:d,mountPreviewUI:T,findContentWithId:I,updateContent:$,removeContentWithId:N,requestRerender:y}};export{B as useStudio};
