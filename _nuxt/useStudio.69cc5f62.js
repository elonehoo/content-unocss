import{u as U,b,m as k,h as R}from"./query.d5d7469f.js";import{d as L,k as S,m as T,r as A,n as N}from"./entry.da60e72f.js";import O from"./ContentPreviewMode.bc00a948.js";import{J as j}from"./runtime-core.esm-bundler.ac1ee3c4.js";import"./_plugin-vue_export-helper.c27b6911.js";/* empty css                                                                           */const F=(r,o,v)=>{const p=[...o||[]],m=[...v||[]],i=[...r||[]];for(const e of p)if(e.oldPath)if(m.splice(m.findIndex(a=>a.path===e.oldPath),1),p.find(a=>a.path===e.oldPath))i.push({path:e.path,parsed:e.parsed});else{const a=i.find(d=>d.path===e.oldPath);a&&(a.path=e.path,e.parsed?a.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(d=>{a.parsed[d]=e.pathMeta[d]}))}else if(e.new)i.push({path:e.path,parsed:e.parsed});else{const c=i.find(a=>a.path===e.path);c&&Object.assign(c,{path:e.path,parsed:e.parsed})}for(const e of m)i.splice(i.findIndex(c=>c.path===e.path),1);return i},J=r=>{let o;return(...v)=>(o||(o=r()),o)},E=J(()=>JSON.parse(JSON.stringify(N()))),B=()=>{var y,C,I,$;const r=U(),o=b().public.studio||{},v=E(),p=($=(I=(C=(y=r==null?void 0:r.vueApp)==null?void 0:y._context)==null?void 0:C.config)==null?void 0:I.globalProperties)==null?void 0:$.$pinceauTheme,m={},i=L("client-db",()=>null),e=k("previewToken",{sameSite:"none",secure:!0}),c=async(t,s,n=!0)=>{const f=await t.getKeys(`${e.value}:`);await Promise.all(f.map(l=>t.removeItem(l))),await t.setItem(`${e.value}$`,JSON.stringify({ignoreBuiltContents:n})),await Promise.all(s.map(l=>{var h;return t.setItem(`${e.value}:${(h=l.parsed)==null?void 0:h._id}`,JSON.stringify(l.parsed))}))},a=t=>{R(r,S,[t||v])},d=t=>{!p||!(p!=null&&p.updateTheme)||R(r,p.updateTheme,[t||m])},w=async t=>{const s=await $fetch("api/projects/preview",{baseURL:o.apiURL,params:{token:e.value}}),n=F(s.files,s.additions,s.deletions),f=n.filter(u=>u.path.startsWith("content"));await c(t,f,(s.files||[]).length!==0);const l=n.filter(u=>u.path.startsWith(".studio")),h=l.find(u=>u.path===".studio/app.config.json");a(h==null?void 0:h.parsed);const g=l.find(u=>u.path===".studio/tokens.config.json");d(g==null?void 0:g.parsed)},P=async()=>{await $fetch("api/projects/preview/sync",{baseURL:o.apiURL,method:"POST",params:{token:e.value}})},_=t=>{const s=j(()=>!!t.value),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),T(O,{previewToken:e,apiURL:o.apiURL,storageReady:s,refresh:()=>w(t.value).then(()=>A()),init:P}).mount(n)},x=async t=>{var n,f;if(!t)return null;t=t.replace(/\/$/,"");let s=await((n=i.value)==null?void 0:n.getItem(`${e.value}:${t}`));return s||(s=await((f=i.value)==null?void 0:f.getItem(t))),s};return{apiURL:o.apiURL,previewToken:e,contentStorage:i,syncPreview:w,syncPreviewFiles:c,syncPreviewAppConfig:a,syncPreviewTokensConfig:d,requestPreviewSynchronization:P,mountPreviewUI:_,findContentWithId:x}};export{B as useStudio};
